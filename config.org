#+title: Emacs Literate Config
#+author: Connor Dunning
#+STARTUP: content
#+PROPERTY: header-args:emacs-lisp :tangle ./init.el :results silent

This is my Emacs config. It's hopefully declarative and reproducable. To get things up and running:
1. Delete the bundled org-mode package to make room for the newest version. Check the *lisp-directory* variable, and delete 'org/'
2. eval the *Straight.el* block.
3. eval the *Org-mode* block, and *Literate Programming* sub item.
4. Save the file, you may have to run *org-babel-tangle* the first time but it should tangle automaticly afterwards.
5. ensure 'early-init.el' is present *BEFORE* you restart emacs. It should have been created; if not, copy the code from the *early-init.el* block.
6. Installing Emacs Application Framework requires some manual steps, as detailed below.

The 'config.org' file will then tangle to 'init.el' when saved, so do that and restart emacs to load any changes.

I'm building this out as I go. I'm not /too/ worried about start up time buuuuut I'm trying to keep things slim.
*Citations* 
- I took plenty of code blocks from David Wilson of https://systemcrafters.net/, his "emacs from scratch" series specifically.
- Coming from DOOM emacs I also took a lot of inspiration from that project (Henrik Lissner) https://github.com/doomemacs/doomemacs.
- A Life Configuring emacs, [[https://alhassy.github.io/][Musa Al-hassy]]

* early-init.el
manual: https://www.gnu.org/software/emacs/manual/html_node/emacs/Early-Init-File.html
This block tangles to the early-init file and has a safety check incase it tangles to init.el
#+begin_src emacs-lisp :tangle early-init.el
  (when (string-equal (file-name-nondirectory (or load-file-name buffer-file-name)) "early-init.el")
    (message "Loading early-init.el")
    (setq package-enable-at-startup nil)
    (setenv "LSP_USE_PLISTS" "true"))
#+end_src

* Straight.el
Repo: https://github.com/radian-software/straight.el
*Bootstrapping*
#+begin_src emacs-lisp
   ;;; -*- lexical-binding: t; -*-
  (setq straight-use-package-by-default t) ; use-package invokes straight.el

  (defvar bootstrap-version)
  (let ((bootstrap-file
         (expand-file-name
          "straight/repos/straight.el/bootstrap.el"
          (or (bound-and-true-p straight-base-dir)
              user-emacs-directory)))
        (bootstrap-version 7))
    (unless (file-exists-p bootstrap-file)
      (with-current-buffer
          (url-retrieve-synchronously
           "https://raw.githubusercontent.com/radian-software/straight.el/develop/install.el"
           'silent 'inhibit-cookies)
        (goto-char (point-max))
        (eval-print-last-sexp)))
    (load bootstrap-file nil 'nomessage))

  (straight-use-package 'org) ; Reinstall Org
  (straight-use-package 'use-package)
  (setq straight-vc-git-default-clone-depth '(1 single-branch))  
  (setq use-package-verbose t) 
#+end_src

* Global Configuration
#+begin_src emacs-lisp
  ;;(setq auto-save-default nil)
  (setq auto-save-file-name-transforms '((".*" "~/.emacs.d/saves/" t)))
  (setq
   backup-by-copying t                    ; don't clobber symlinks
   backup-directory-alist
   '(("." . "~/.emacs.d/saves/"))         ; no more littering of backups
   delete-old-versions t
   kept-new-versions 6
   kept-old-versions 2
   version-control t                      ; use versioned backups
   global-auto-revert-non-file-buffers t) ; update things like dired

  (global-auto-revert-mode 1)             ; update buffers when files change
  (save-place-mode 1)                     ; remember cursor location
  (recentf-mode +1)
  (electric-pair-mode 1)
#+end_src

** undo-tree
#+begin_src emacs-lisp
  (use-package undo-tree
    :bind
    ("C-x u" . undo-tree-visualize)
    ;;("k" . undo-tree-visualize-undo)
    ;;("j" . undo-tree-visualize-redo)
    ;;("h" . undo-tree-visualize-switch-branch-left)
    ;;("l" . undo-tree-visualize-switch-branch-right)
    :config
    (setq undo-tree-visualizer-timestamps t)
    (setq undo-tree-visualizer-diff t)
    (setq undo-tree-history-directory-alist '(("." . "~/.emacs.d/undo"))))

  (global-undo-tree-mode)
#+end_src

* DISABLED: Emacs Application Framework
repo: https://github.com/emacs-eaf/emacs-application-framework

Clone the repo
#+begin_src shell
  git clone --depth=1 -b master https://github.com/emacs-eaf/emacs-application-framework.git ~/.emacs.d/site-lisp/emacs-application-framework/;
#+end_src

then run install-eaf.py

#+begin_src emacs-lisp :tangle no
  (use-package eaf
    :load-path "~/.emacs.d/site-lisp/emacs-application-framework"
    :custom
                                          ; See https://github.com/emacs-eaf/emacs-application-framework/wiki/Customization
    (eaf-browser-continue-where-left-off t)
    (eaf-browser-enable-adblocker t)
    (browse-url-browser-function 'eaf-open-browser)
    :config
    (defalias 'browse-web #'eaf-open-browser)
    ;;(eaf-bind-key scroll_up "C-n" eaf-pdf-viewer-keybinding)
    ;;(eaf-bind-key scroll_down "C-p" eaf-pdf-viewer-keybinding)
    ;;(eaf-bind-key take_photo "p" eaf-camera-keybinding)
    ;;(eaf-bind-key nil "M-q" eaf-browser-keybinding)) ;; unbind, see more in the Wiki
    

    ;;(require 'eaf-file-manager)
    ;;(require 'eaf-pyqterminal)
    ;;(require 'eaf-image-viewer)
    ;;(require 'eaf-system-monitor)
    ;;(require 'eaf-pdf-viewer)
    ;;(require 'eaf-mind-elixir)
    ;;(require 'eaf-music-player)
    ;;(require 'eaf-org-previewer)
    ;;(require 'eaf-rss-reader)
    ;;(require 'eaf-camera)
    (require 'eaf-browser)
    ;;(require 'eaf-markmap)
    ;;(require 'eaf-video-player)
    ;;(require 'eaf-markdown-previewer)
    ;;(require 'eaf-mindmap)
#+end_src

* EXWM Emacs Window Manager
User Guide: https://github.com/emacs-exwm/exwm/wiki

*Adjust home folder path if needed*
#+begin_src shell :tangle emacs.desktop
  [Desktop Entry]
  Name=EXWM
  Exec=/home/connor/.emacs.d/start-exwm.sh
  Type=Application
#+end_src

#+begin_src shell :tangle start-exwm.sh
  #!/bin/sh
  xrandr --output eDP-1 --primary --mode 1920x1080 --pos 1080x604 --rotate normal --output DP-1 --off --output HDMI-1 --off --output DP-2 --off --output HDMI-2 --mode 1920x1080 --pos 0x0 --rotate left;
  picom &
  exec emacs -mm --debug-init
#+end_src

Need to copy this to /usr/share/xsessions/emacs.desktop. Run manually 
#+begin_src shell :tangle no :results list
  sudo cp emacs.desktop /usr/share/xsessions/
#+end_src

#+begin_src emacs-lisp
  ;; Remap CapsLock to Ctrl
  (start-process-shell-command "xmodmap" nil "xmodmap ~/.emacs.d/Xmodmap")
  					;(defun efs/exwm-update-class ()
  					;  (exwm-workspace-rename-buffer exwm-class-name))

  (defun efs/run-in-background (command)
    (let ((command-parts (split-string command "[ ]+")))
      (apply #'call-process `(,(car command-parts) nil 0 nil ,@(cdr command-parts)))))

  (defun dw/exwm-init-hook ()
    ;; Make workspace 1 be the one where we land at startup
    (exwm-workspace-switch-create 1))

  (use-package exwm
    :config
    ;; Set the default number of workspaces
    (setq exwm-workspace-number 5)

    ;; THIS RUINS EVERYTHING
  					;(add-hook 'exwm-init-hook #'efs/after-exwm-init)
    
    ;; When window "class" updates, use it to set the buffer name
  					;(add-hook 'exwm-update-class-hook #'efs/exwm-update-class)

    ;; These keys should always pass through to Emacs
    (setq exwm-input-prefix-keys
          '(?\C-x
            ?\C-w
            ?\C-u
            ?\C-h
            ?\M-x
            ?\M-`
            ?\M-&
            ?\M-:
            ?\C-\M-j  ;; Buffer list
            ?\C-\ ))  ;; Ctrl+Space

    ;; Ctrl+Q will enable the next key to be sent directly
    (define-key exwm-mode-map [?\C-q] 'exwm-input-send-next-key)

    ;; Set up global key bindings.  These always work, no matter the input state!
    ;; Keep in mind that changing this list after EXWM initializes has no effect.
    (setq exwm-input-global-keys
          `(
            ;; Reset to line-mode (C-c C-k switches to char-mode via exwm-input-release-keyboard)
            ([?\s-r] . exwm-reset)

            ;; Move between windows
            ([?\s-h] . windmove-left)
            ([?\s-l] . windmove-right)
            ([?\s-k] . windmove-up)
            ([?\s-j] . windmove-down)
            ([?\s-c] . kill-current-buffer)
            ([?\s-C] . kill-buffer-and-window)
            ;; Launch applications via shell command
            ([?\s-x] . (lambda (command)
                         (interactive (list (read-shell-command "$ ")))
                         (start-process-shell-command command nil command)))

            ;; Switch workspace
            ([?\s-w] . exwm-workspace-switch)

            ;; 's-N': Switch to certain workspace with Super (Win) plus a number key (0 - 9)
            ,@(mapcar (lambda (i)
                        `(,(kbd (format "s-%d" i)) .
                          (lambda ()
                            (interactive)
                            (exwm-workspace-switch-create ,i))))
                      (number-sequence 0 9))))

    (exwm-randr-mode)
    (exwm-systemtray-mode)
    (exwm-wm-mode))


  (efs/run-in-background "nm-applet")
  (display-battery-mode 1)
  (setq display-time-day-and-date t)
  (display-time-mode 1)

  (use-package desktop-environment
    :after exwm
    :config (desktop-environment-mode)
    :custom
    (desktop-environment-brightness-small-increment "2%+")
    (desktop-environment-brightness-small-decrement "2%-")
    (desktop-environment-brightness-normal-increment "5%+")
    (desktop-environment-brightness-normal-decrement "5%-"))
#+end_src

** EXWM Second Monitor Fix
This sucks and is a hack. I have to call this after the Second monitor is awake from standby and Emacs can see it. 
#+begin_src emacs-lisp
   (defun efs/exwm-update-class ()
     "Rename EXWM buffer to match its class name."
     (exwm-workspace-rename-buffer exwm-class-name))

   (add-hook 'exwm-update-class-hook #'efs/exwm-update-class)

   (defun m2-fix ()
     "Set EXWM monitor configuration and refresh."
     (interactive)
     (setq exwm-randr-workspace-monitor-plist '(2 "HDMI-2" 3 "HDMI-2"))
     (exwm-randr-refresh))

  (defun capsFix ()
    (interactive)
    (start-process-shell-command "xmodmap" nil "xmodmap ~/.emacs.d/Xmodmap")) 
#+end_src

* PDF-tools
repo: https://github.com/vedang/pdf-tools
#+begin_src emacs-lisp
  (use-package pdf-tools)
#+end_src

* Completion & Minibuffer
** Consult
repo: https://github.com/minad/consult
wiki: https://github.com/minad/consult/wiki  
#+begin_src emacs-lisp
  ;; Example configuration for Consult
  (use-package consult
    ;; Replace bindings. Lazily loaded by `use-package'.
    :bind (;; C-c bindings in `mode-specific-map'
           ("C-c M-x" . consult-mode-command)
           ("C-c h" . consult-history)
           ("C-c k" . consult-kmacro)
           ("C-c m" . consult-man)
           ("C-c i" . consult-info)
           ([remap Info-search] . consult-info)
           ;; C-x bindings in `ctl-x-map'
           ("C-x M-:" . consult-complex-command)     ;; orig. repeat-complex-command
           ("C-x b" . consult-buffer)                ;; orig. switch-to-buffer
           ("C-x 4 b" . consult-buffer-other-window) ;; orig. switch-to-buffer-other-window
           ("C-x 5 b" . consult-buffer-other-frame)  ;; orig. switch-to-buffer-other-frame
           ("C-x t b" . consult-buffer-other-tab)    ;; orig. switch-to-buffer-other-tab
           ("C-x r b" . consult-bookmark)            ;; orig. bookmark-jump
           ("C-x p b" . consult-project-buffer)      ;; orig. project-switch-to-buffer
           ;; Custom M-# bindings for fast register access
           ("M-#" . consult-register-load)
           ("M-'" . consult-register-store)          ;; orig. abbrev-prefix-mark (unrelated)
           ("C-M-#" . consult-register)
           ;; Other custom bindings
           ("M-y" . consult-yank-pop)                ;; orig. yank-pop
           ;; M-g bindings in `goto-map'
           ("M-g e" . consult-compile-error)
           ("M-g r" . consult-grep-match)
           ("M-g f" . consult-flymake)               ;; Alternative: consult-flycheck
           ("M-g g" . consult-goto-line)             ;; orig. goto-line
           ("M-g M-g" . consult-goto-line)           ;; orig. goto-line
           ("M-g o" . consult-outline)               ;; Alternative: consult-org-heading
           ("M-g m" . consult-mark)
           ("M-g k" . consult-global-mark)
           ("M-g i" . consult-imenu)
           ("M-g I" . consult-imenu-multi)
           ;; M-s bindings in `search-map'
           ("M-s d" . consult-find)                  ;; Alternative: consult-fd
           ("M-s c" . consult-locate)
           ("M-s g" . consult-grep)
           ("M-s G" . consult-git-grep)
           ("M-s r" . consult-ripgrep)
           ("M-s l" . consult-line)
           ("M-s L" . consult-line-multi)
           ("M-s k" . consult-keep-lines)
           ("M-s u" . consult-focus-lines)
           ;; Isearch integration
           ("M-s e" . consult-isearch-history)
           :map isearch-mode-map
           ("M-e" . consult-isearch-history)         ;; orig. isearch-edit-string
           ("M-s e" . consult-isearch-history)       ;; orig. isearch-edit-string
           ("M-s l" . consult-line)                  ;; needed by consult-line to detect isearch
           ("M-s L" . consult-line-multi)            ;; needed by consult-line to detect isearch
           ;; Minibuffer history
           :map minibuffer-local-map
           ("M-s" . consult-history)                 ;; orig. next-matching-history-element
           ("M-r" . consult-history))                ;; orig. previous-matching-history-element

    ;; Enable automatic preview at point in the *Completions* buffer. This is
    ;; relevant when you use the default completion UI.
    :hook (completion-list-mode . consult-preview-at-point-mode)

    ;; The :init configuration is always executed (Not lazy)
    :init

    ;; Tweak the register preview for `consult-register-load',
    ;; `consult-register-store' and the built-in commands.  This improves the
    ;; register formatting, adds thin separator lines, register sorting and hides
    ;; the window mode line.
    (advice-add #'register-preview :override #'consult-register-window)
    (setq register-preview-delay 0.5)

    ;; Use Consult to select xref locations with preview
    (setq xref-show-xrefs-function #'consult-xref
          xref-show-definitions-function #'consult-xref)

    ;; Configure other variables and modes in the :config section,
    ;; after lazily loading the package.
    :config

    ;; Optionally configure preview. The default value
    ;; is 'any, such that any key triggers the preview.
    ;; (setq consult-preview-key 'any)
    ;; (setq consult-preview-key "M-.")
    ;; (setq consult-preview-key '("S-<down>" "S-<up>"))
    ;; For some commands and buffer sources it is useful to configure the
    ;; :preview-key on a per-command basis using the `consult-customize' macro.
    (consult-customize
     consult-theme :preview-key '(:debounce 0.2 any)
     consult-ripgrep consult-git-grep consult-grep consult-man
     consult-bookmark consult-recent-file consult-xref
     consult--source-bookmark consult--source-file-register
     consult--source-recent-file consult--source-project-recent-file
     ;; :preview-key "M-."
     :preview-key '(:debounce 0.4 any))

    ;; Optionally configure the narrowing key.
    ;; Both < and C-+ work reasonably well.
    (setq consult-narrow-key "<") ;; "C-+"

    ;; Optionally make narrowing help available in the minibuffer.
    ;; You may want to use `embark-prefix-help-command' or which-key instead.
    ;; (keymap-set consult-narrow-map (concat consult-narrow-key " ?") #'consult-narrow-help)
    )
#+end_src

** Vertico & Extensions
Repos:
- [[https://github.com/minad/vertico][vertico]]
- [[https://github.com/minad/marginalia][marginalia]] adds details to options in the completion minibuffers
- [[https://github.com/oantolin/orderless][orderless]]

#+begin_src emacs-lisp
  (use-package vertico
    :ensure t
    :bind (:map vertico-map
                ("C-j" . vertico-next)
                ("C-k" . vertico-previous)
                ("C-f" . vertico-exit)
                :map minibuffer-local-map
                ("M-h" . backward-kill-word))
    :custom
    (vertico-cycle t)
    (enable-recursive-minibuffers t)
    :init
    (vertico-mode))
  (use-package savehist
    :init
    (savehist-mode))

  (use-package marginalia
    ;; Bind `marginalia-cycle' locally in the minibuffer.  To make the binding
    ;; available in the *Completions* buffer, add it to the
    ;; `completion-list-mode-map'.
    :bind (:map minibuffer-local-map
                ("M-A" . marginalia-cycle))
    :init
    ;; Marginalia must be activated in the :init section of use-package such that
    (marginalia-mode))

  (use-package nerd-icons-completion
    :after marginalia
    :config
    (nerd-icons-completion-mode)
    (add-hook 'marginalia-mode-hook #'nerd-icons-completion-marginalia-setup))

  (use-package orderless
    :ensure t
    :custom
    (completion-styles '(basic orderless))
    (completion-category-overrides '((file (styles basic partial-completion)))))

  ;; A more bash-like prefix exxpansion
  (keymap-set vertico-map "?" #'minibuffer-completion-help)
  (keymap-set vertico-map "TAB" #'minibuffer-complete)
#+end_src

** Which-key
Repo: https://github.com/justbur/emacs-which-key (ARCHIVED part of Emacs now)
#+begin_src emacs-lisp
  (use-package which-key
    :init (which-key-mode)
    :diminish
    :config
    (setq which-key-idle-delay 0.1))
  (which-key-setup-minibuffer)
  (setq which-key-popup-type 'minibuffer)
  ;;(which-key-setup-side-window-right-bottom)
  (which-key-add-key-based-replacements
    "SPC :"     "M-x"
    "SPC o"     "Other window"
    "SPC o t"   "vTerm"
    "SPC b"     "Buffer"
    "SPC b b"   "switch Buffer"
    "SPC b d"   "Delete"
    "SPC b n"   "Next"
    "SPC g"     "maGit"
    "SPC f"     "File"
    "SPC f s"   "Save"
    "SPC f c"   "Config"
    "SPC f r"   "find Recent"
    "SPC n"     "Notes"
    "SPC n i" "Note Insert link"
    "SPC n l" "Note Links buffer toggle"
    "SPC n c" "Note Create (add id to heading)"
    "SPC n u" "Note Ui"
    "SPC n f" "Note Find-node")

  ;; paging doesn't seem to work in which-key
  (global-set-key [next] 'which-key-show-next-page-cycle)
  (global-set-key [prior] 'which-key-show-previous-page-cycle)

#+End_src

** TODO checkout the built-in completion stuff
https://www.youtube.com/watch?v=-ZeoGVtMLaU
* Embark
Repo: https://github.com/oantolin/embark
#+begin_src emacs-lisp
  (use-package embark
    :ensure t

    :bind
    (("C-." . embark-act)         ;; pick some comfortable binding
     ("C-;" . embark-dwim)        ;; good alternative: M-.
     ("C-h B" . embark-bindings)) ;; alternative for `describe-bindings'

    :init

    :config

    ;; Hide the mode line of the Embark live/completions buffers
    (add-to-list 'display-buffer-alist
                 '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
                   nil
                   (window-parameters (mode-line-format . none)))))

  ;; Consult users will also want the embark-consult package.
  (use-package embark-consult
    :ensure t ; only need to install it, embark loads it after consult if found
    :hook
    (embark-collect-mode . consult-preview-at-point-mode))
#+end_src

* Helpful
Repo: https://github.com/Wilfred/helpful
#+begin_src emacs-lisp
  (use-package helpful
    :bind (
    	 :map helpful-mode-map
    	 ("<escape>" . 'kill-buffer-and-window)))

  (global-set-key (kbd "C-h f") #'helpful-callable)
  (global-set-key (kbd "C-h v") #'helpful-variable)
  (global-set-key (kbd "C-h o") #'helpful-symbol)
  (global-set-key (kbd "C-h k") #'helpful-key)
  (global-set-key (kbd "C-h x") #'helpful-command)
  (global-set-key (kbd "C-h C-h") #'helpful-at-point)
#+end_src

* Evil-mode
Docs/Repo:
- [[https://evil.readthedocs.io/en/latest/overview.html][evil-mode]]
- [[https://github.com/emacs-evil/evil-collection][evil-collection]]
#+begin_src emacs-lisp
  (use-package evil
    :init
    (setq evil-want-integration t)
    (setq evil-want-keybinding nil)
    (setq evil-want-C-u-scroll t)
    (setq evil-want-C-i-jump nil)
    :config
    (evil-mode 1)
    (define-key evil-insert-state-map (kbd "C-g") 'evil-normal-state)
    (define-key evil-insert-state-map (kbd "C-h") 'evil-delete-backward-char-and-join)

    ;; Use visual line motions even outside of visual-line-mode buffers
    (evil-global-set-key 'motion "j" 'evil-next-visual-line)
    (evil-global-set-key 'motion "k" 'evil-previous-visual-line)

    (evil-set-initial-state 'messages-buffer-mode 'normal)
    (evil-set-initial-state 'dashboard-mode 'normal)
    (evil-set-undo-system 'undo-tree))

  (use-package evil-collection
    :after evil
    :config
    (evil-collection-init))
#+end_src

* Other Keybindings
#+begin_src emacs-lisp
  (global-set-key (kbd "<escape>") 'keyboard-escape-quit)
  (global-set-key (kbd "C-=") 'text-scale-increase)
  (global-set-key (kbd "C--") 'text-scale-decrease)

  (define-prefix-command 'leader-key)
  (define-key evil-normal-state-map (kbd "SPC") 'leader-key)
  (define-key global-map (kbd "C-SPC") 'leader-key)

  (dolist (pair '((":"   . execute-extended-command)
  		("."   . embark-act)
  		("f r" . recentf)
  		("f c" . (lambda () 
                             (interactive) 
                             (find-file (expand-file-name "~/.emacs.d/config.org"))))
  		("f s" . write-file)
  		("n u" . org-roam-ui-mode)
  		("n f" . org-roam-node-find)
  		("n i" . org-roam-node-insert)
  		("n c" . org-id-get-create)
  		("n l" . org-roam-buffer-toggle)
  		("b b" . consult-buffer)
  		("t" . vterm-toggle)
  		("o t" . vterm-other-window)
  		("b k" . kill-current-buffer)
  		("b K" . kill-buffer-and-window)
  		("b n" . next-buffer)
                  ("g"   . magit-status)))
    (define-key leader-key (kbd (car pair)) (cdr pair)))
  (global-set-key (kbd "C-SPC") 'avy-goto-char-timer) ; Go anywhere with avy
  (global-set-key (kbd "C-x C-SPC") 'avy-pop-mark) ; Go back
#+end_src

* Looks
** Modeline
Repo: https://github.com/seagle0128/doom-modeline
#+begin_src emacs-lisp
  (use-package doom-modeline
    :ensure t
    :init (doom-modeline-mode 1)
    :custom ((doom-modeline-height 20)))
  (setq doom-modeline-major-mode-color-icon t)
  (setq doom-modeline-buffer-state-icon t)
  (setq doom-modeline-buffer-modification-icon t)
  (setq doom-modeline-vcs-display-function #'doom-modeline-vcs-name)
#+end_src

** Theme
Docs: https://protesilaos.com/emacs/modus-themes
*DISABLED*
#+begin_src emacs-lisp :tangle no
  (use-package modus-themes
    :config ; add cusomizations prior to loading theme
    (setq modus-themes-italic-constructs t
  	modus-themes-bold-constructs t
  	modus-themes-mixed-fonts t
          modus-themes-variable-pitch-ui nil
  	modus-themes-custom-auto-reload t
  	modus-themes-disable-other-themes t)
    (setq modus-themes-common-palette-overrides
  	'((bg-prose-block-contents bg-yellow-nuanced)
  	  (bg-prose-block-delimiter bg-ochre)
  	  (fg-prose-block-delimiter fg-main)))
    
    (set-fringe-mode 0)
    (setq window-divider-default-right-width 2)
    (set-face-foreground 'window-divider "DimGrey")

    :init
    (load-theme 'modus-operandi-tinted :no-confirm))
#+end_src

Manual: https://protesilaos.com/emacs/ef-themes
#+begin_src emacs-lisp 
  (use-package ef-themes
    :straight (:type git :host github :repo "protesilaos/ef-themes")
    :init
    (modus-themes-include-derivatives-mode 1)
    :config
    (setq ef-eagle-palette-overrides
          '((link cyan)))
    (setq ef-themes-to-toggle '(ef-eagle ef-elea-dark))
    (mapc #'disable-theme custom-enabled-themes)
    (setq modus-themes-mixed-fonts t)
    (setq modus-themes-italic-constructs t)
    (modus-themes-load-theme 'ef-eagle))
#+end_src

** Fonts
#+begin_src emacs-lisp
  (use-package fontaine)

  (setq fontaine-latest-state-file
        (locate-user-emacs-file "fontaine-latest-state.eld"))

  (setq fontaine-presets
        '((small
           :default-family "Iosevka"
           :default-height 80
           :variable-pitch-family "Iosevka Aile") ;Aile
          (regular) ; like this it uses all the fallback values and is named `regular'
          (medium
           :default-weight semilight
           :default-height 115
           :bold-weight extrabold)
          (large
           :inherit medium
           :default-height 150)
          (presentation
           :default-height 180)
          (t
           ;; I keep all properties for didactic purposes, but most can be
           ;; omitted.  See the fontaine manual for the technicalities:
           ;; <https://protesilaos.com/emacs/fontaine>.
           :default-family "Iosevka"
           :default-weight regular
           :default-height 100

           :fixed-pitch-family nil ; falls back to :default-family
           :fixed-pitch-weight nil ; falls back to :default-weight
           :fixed-pitch-height 1.0

           :fixed-pitch-serif-family nil ; falls back to :default-family
           :fixed-pitch-serif-weight nil ; falls back to :default-weight
           :fixed-pitch-serif-height 1.0

           :variable-pitch-family "Iosevka Aile" ;Aile
           :variable-pitch-weight nil
           :variable-pitch-height 1.0

           :mode-line-active-family nil ; falls back to :default-family
           :mode-line-active-weight nil ; falls back to :default-weight
           :mode-line-active-height 0.9

           :mode-line-inactive-family nil ; falls back to :default-family
           :mode-line-inactive-weight nil ; falls back to :default-weight
           :mode-line-inactive-height 0.9

           :header-line-family nil ; falls back to :default-family
           :header-line-weight nil ; falls back to :default-weight
           :header-line-height 0.9

           :line-number-family nil ; falls back to :default-family
           :line-number-weight nil ; falls back to :default-weight
           :line-number-height 0.9

           :tab-bar-family nil ; falls back to :default-family
           :tab-bar-weight nil ; falls back to :default-weight
           :tab-bar-height 1.0

           :tab-line-family nil ; falls back to :default-family
           :tab-line-weight nil ; falls back to :default-weight
           :tab-line-height 1.0

           :bold-family nil ; use whatever the underlying face has
           :bold-weight bold

           :italic-family nil
           :italic-slant italic

           :line-spacing nil)))

  ;; Set the last preset or fall back to desired style from `fontaine-presets'
  ;; (the `regular' in this case).
  (fontaine-set-preset (or (fontaine-restore-latest-preset) 'regular))

  ;; Persist the latest font preset when closing/starting Emacs and
  ;; while switching between themes.
  (fontaine-mode 1)

  ;; fontaine does not define any key bindings.  This is just a sample that
  ;; respects the key binding conventions.  Evaluate:
  ;;
  ;;     (info "(elisp) Key Binding Conventions")
  (define-key global-map (kbd "C-c f") #'fontaine-set-preset)
#+end_src

** Scrolling
Repo: https://github.com/zk-phi/sublimity
#+begin_src emacs-lisp
  (use-package sublimity
    :config
    (require 'sublimity-scroll)
    (setq sublimity-scroll-vertical-frame-delay 0.002)
    (setq sublimity-scroll-weight 12)
    (setq sublimity-scroll-drift-length 5)
    :init
    (sublimity-mode +1))
#+end_src
** Misc
#+begin_src emacs-lisp
  (use-package rainbow-delimiters
    :hook (prog-mode . rainbow-delimiters-mode))

  ;; The goal of this package is to stop the minibuffer from centering the main window
  ;; It does not seem to be working.
  (use-package mini-ontop
    :straight (mini-ontop :type git :host github :repo "hkjels/mini-ontop.el"))
  (mini-ontop-mode 1)

  (setq inhibit-startup-message t  ; Don't show the splash screen
        visible-bell t)            ; Flash when the bell rings

  (tool-bar-mode -1)
  (scroll-bar-mode -1)
  (menu-bar-mode -1)
  (set-fringe-mode 0)

  ;; Don't wrap lines
  (setq-default truncate-lines t)

  ;; Line numbers by default, exclude spec. modes
  (global-display-line-numbers-mode 1)
  (dolist (mode '(org-mode-hook
     		term-mode-hook
     		vterm-mode-hook
     		shell-mode-hook
     		eshell-mode-hook
  		treemacs-mode-hook))
    (add-hook mode (lambda () (display-line-numbers-mode 0))))
#+end_src

* Org-mode
Manual: https://orgmode.org/org.html
Worg: https://orgmode.org/worg/
#+begin_src emacs-lisp
  (defun efs/org-mode-setup ()
    (org-indent-mode)
    (variable-pitch-mode 1)
    (visual-line-mode 1)
    (org-superstar-mode)
    (flyspell-mode 1)
    (global-visual-fill-column-mode)
    (set-fill-column 120)
    (visual-fill-column-toggle-center-text))

  (use-package org
    :hook
    (org-mode . efs/org-mode-setup)
    :config
    (setq org-ellipsis " â–¾")
    
    ;; Replace list hyphen with dot
    (font-lock-add-keywords 'org-mode
          		  '(("^ *\\([-]\\) "
          		     (0 (prog1 () (compose-region (match-beginning 1) (match-end 1) "â€¢"))))))

    ;; Set faces for heading levels
    (dolist (face '((org-level-1 . 1.4)
                    (org-level-2 . 1.2)
                    (org-level-3 . 1.1)
                    (org-level-4 . 1.1)
                    (org-level-5 . 1.1)
                    (org-level-6 . 1.1)
                    (org-level-7 . 1.1)
                    (org-level-8 . 1.1)))
      (set-face-attribute (car face) nil :height (cdr face)))

    ;; Ensure that anything that should be fixed-pitch in Org files appears that way
  					;(set-face-attribute 'fixed-pitch nil :font "BlexMono Nerd Font") 
    
    (set-face-attribute 'org-block nil :foreground nil :inherit 'fixed-pitch)
    (set-face-attribute 'org-code nil   :inherit '(shadow fixed-pitch))
    (set-face-attribute 'org-table nil   :inherit '(shadow fixed-pitch))
    (set-face-attribute 'org-verbatim nil :inherit '(shadow fixed-pitch))
    (set-face-attribute 'org-special-keyword nil :inherit '(font-lock-comment-face fixed-pitch))
    (set-face-attribute 'org-meta-line nil :inherit '(font-lock-comment-face fixed-pitch))
    (set-face-attribute 'org-checkbox nil :inherit 'fixed-pitch))

  ;; fixed width font check
  ;; mmmmmm
  ;; nnnnnn
  ;; 000000
  ;; wwwwww

  ;;(setq org-superstar-headline-bullets-list '("â—‰" ("ðŸž›" ?â—ˆ) "â—‹" "â–·"))

  (setq org-superstar-headline-bullets-list '("â—‰" "â—ˆ" "â—‹" "â–·"))
  (use-package org-superstar)
  (use-package visual-fill-column)
  (setq org-hide-emphasis-markers t)
#+end_src

** Literate Programming
Docs (worg): https://orgmode.org/worg/org-contrib/babel/intro.html
Home Page: https://orgmode.org/worg/org-contrib/babel/

*Structure Templates* can be inserted by typing  *<i <TAB>*  where 'i' is one of:
| Specifier | Block Type                               |
|-----------+------------------------------------------|
| a         | â€˜#+begin_export asciiâ€™ â€¦ â€˜#+end_exportâ€™ |
| c         | â€˜#+begin_centerâ€™ â€¦ â€˜#+end_centerâ€™       |
| c         | â€˜#+begin_commentâ€™ â€¦ â€˜#+end_commentâ€™     |
| e         | â€˜#+begin_exampleâ€™ â€¦ â€˜#+end_exampleâ€™     |
| e         | â€˜#+begin_exportâ€™ â€¦ â€˜#+end_exportâ€™       |
| h         | â€˜#+begin_export htmlâ€™ â€¦ â€˜#+end_exportâ€™  |
| l         | â€˜#+begin_export latexâ€™ â€¦ â€˜#+end_exportâ€™ |
| q         | â€˜#+begin_quoteâ€™ â€¦ â€˜#+end_quoteâ€™         |
| s         | â€˜#+begin_srcâ€™ â€¦ â€˜#+end_srcâ€™             |
| sh        | shell                                    |
| el        | emacs-lisp                               |
| py        | python                                   |
| v         | â€˜#+begin_verseâ€™ â€¦ â€˜#+end_verseâ€™         |

#+begin_src emacs-lisp
  ;; Execute code in org-mode code blocks
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((emacs-lisp . t)
     (python . t)
     (shell . t)))
  (push '("conf-unix" . conf-unix) org-src-lang-modes)

  ;; Automatically tangle config.org config file 
  (defun efs/org-babel-tangle-config ()
    (when (string-equal (file-name-nondirectory (buffer-file-name)) "config.org")
      (let ((org-confirm-babel-evaluate nil))
        (org-babel-tangle))))
  (add-hook 'org-mode-hook (lambda () (add-hook 'after-save-hook #'efs/org-babel-tangle-config)))

  (require 'org-tempo)
  (add-to-list 'org-structure-template-alist '("sh" . "src shell"))
  (add-to-list 'org-structure-template-alist '("el" . "src emacs-lisp"))
  (add-to-list 'org-structure-template-alist '("py" . "src python"))
#+end_src

** Org-roam
Manual: https://www.orgroam.com/manual.html
#+begin_src emacs-lisp
  (use-package org-roam
    :ensure t
    :custom
    (org-roam-directory "~/org-roam")
    ;;:bind (("C-c n l" . org-roam-buffer-toggle)
    ;;       ("C-c n f" . org-roam-node-find)
    ;;       ("C-c n i" . org-roam-node-insert))

    :config
    (org-roam-db-autosync-enable))

  (use-package websocket
    :after org-roam)

  (use-package org-roam-ui
    :after org-roam ;; or :after org
    :config
    (setq org-roam-ui-sync-theme t
          org-roam-ui-follow t
          org-roam-ui-update-on-save t
          org-roam-ui-open-on-start t))
#+end_src
** DISABLED: howm
Home: https://kaorahi.github.io/howm/
#+begin_src emacs-lisp :tangle no
  (setq howm-view-use-grep t)  ;; use external grep
  (use-package howm
    :ensure t
    :init
    (setq howm-directory "~/howm")
    ;; What format to use for the files?
    (setq howm-file-name-format "%Y-%m-%d-%H%M%S.org")
    (setq howm-view-title-header "#+title: ")
    (setq howm-dtime-format "<%Y-%m-%d %a %H:%M>")
    ;; Avoid conflicts with Org-mode by changing Howm's prefix from "C-c ,".
    (setq howm-prefix (kbd "C-c ;"))
    :bind*
    ;; Conveniently open the Howm menu with "C-c ; ;".
    ("C-c ; ;" . howm-menu))

  ;;(setq howm-template "* #+title: %cursor\n%date\n\n")
#+end_src
** TODO ob-mermaid
Repo: https://github.com/arnm/ob-mermaid
#+begin_src emacs-lisp

#+end_src
* Programming
** magit
Manual: https://magit.vc/manual/magit.html
Reference Card: https://magit.vc/manual/magit-refcard.pdf
#+begin_src emacs-lisp
  (use-package magit
    :commands (magit-status magit-get-current-branch)
    :custom
    (magit-display-buffer-function #'magit-display-buffer-same-window-except-diff-v1))

  (use-package evil-magit
    :after magit)
#+end_src
** TODO Lsp-mode
Docs: https://emacs-lsp.github.io/lsp-mode/
#+begin_src emacs-lisp
  (defun efs/lsp-mode-setup ()
    (setq lsp-headerline-breadcrumb-segments '(path-up-to-project file symbols))
    (lsp-headerline-breadcrumb-mode))

  (use-package lsp-mode
    :commands (lsp lsp-deferred)
    :hook (lsp-mode . efs/lsp-mode-setup)
    :init
    (setq lsp-keymap-prefix "C-c l")  ;; Or 'C-l', 's-l'
    :config
    (lsp-enable-which-key-integration t))
  (add-hook 'prog-mode-hook #'lsp-deferred)
#+end_src

Packages that extend lsp mode:
#+begin_src emacs-lisp
  (use-package lsp-ui
    :hook (lsp-mode . lsp-ui-mode)
    :custom
    (lsp-ui-doc-position 'bottom))

  (use-package lsp-treemacs
    :after lsp)

  (use-package company
    :after lsp-mode
    ;;    :hook (lsp-mode . company-mode)
    :bind (:map company-active-map
                ("<tab>" . company-complete-selection))
    (:map lsp-mode-map
          ("<tab>" . company-indent-or-complete-common))
    :custom
    (company-minimum-prefix-length 1)
    (company-idle-delay 0.0))
  (add-hook 'after-init-hook 'global-company-mode) ;; Company everywhere

  (use-package dap-mode :after lsp-mode :config (dap-auto-configure-mode))

  (use-package yasnippet :config (yas-global-mode))

  (use-package flycheck)

  (use-package company-box
    :hook (company-mode . company-box-mode))
#+end_src

Shutdown lsp automatically
#+begin_src emacs-lisp
  (setq lsp-keep-workspace-alive 'nil) 
#+end_src

** Projectile
Repo: https://github.com/bbatsov/projectile
#+begin_src emacs-lisp
  (use-package projectile
    :diminish
    :ensure t
    :init
    (projectile-mode +1)
    :bind (:map projectile-mode-map
                ("C-c p" . projectile-command-map)))
  ;;(setq projectile-project-search-path '("~/projects/" "~/work/" ("~/Documents/School" . 1)))
  (use-package consult-projectile)
#+end_src

** Languages
lsp-mode integration: https://emacs-lsp.github.io/lsp-mode/page/languages/
*** Java
#+begin_src emacs-lisp
  (use-package lsp-java :config (add-hook 'java-mode-hook 'lsp))
  ;;(use-package dap-java :ensure t)

  (setq lsp-java-vmargs '("-XX:+UseParallelGC" "-XX:GCTimeRatio=4" "-XX:AdaptiveSizePolicyWeight=90" "-XX:+UseStringDeduplication" "-Dsun.zip.disableMemoryMapping=true" "-Xmx4G" "-Xms100m"))
#+end_src

*** JS/TS
Docs: https://docs.deno.com/
#+begin_src emacs-lisp
  (setq lsp-clients-deno-server
        (expand-file-name "~/.deno/bin/deno"))
  (setq lsp-clients-deno-enable-lint t)
#+end_src
* Utilities
** vterm
#+begin_src emacs-lisp
  (use-package vterm
    :ensure t)
  (use-package vterm-toggle
    :bind* ("C-t" . vterm-toggle))
#+end_src
** DISABLED: Treemacs
Repo: https://github.com/Alexander-Miller/treemacs
#+begin_src emacs-lisp :tangle no
  (use-package treemacs
    :ensure t
    :defer t
    :init
    (with-eval-after-load 'winum
      (define-key winum-keymap (kbd "M-0") #'treemacs-select-window))
    :config
    (progn
      (setq treemacs-collapse-dirs                   (if treemacs-python-executable 3 0)
            treemacs-deferred-git-apply-delay        0.5
            treemacs-directory-name-transformer      #'identity
            treemacs-display-in-side-window          t
            treemacs-eldoc-display                   'simple
            treemacs-file-event-delay                2000
            treemacs-file-extension-regex            treemacs-last-period-regex-value
            treemacs-file-follow-delay               0.2
            treemacs-file-name-transformer           #'identity
            treemacs-follow-after-init               t
            treemacs-expand-after-init               t
            treemacs-find-workspace-method           'find-for-file-or-pick-first
            treemacs-git-command-pipe                ""
            treemacs-goto-tag-strategy               'refetch-index
            treemacs-header-scroll-indicators        '(nil . "^^^^^^")
            treemacs-hide-dot-git-directory          t
            treemacs-indentation                     2
            treemacs-indentation-string              " "
            treemacs-is-never-other-window           nil
            treemacs-max-git-entries                 5000
            treemacs-missing-project-action          'ask
            treemacs-move-files-by-mouse-dragging    t
            treemacs-move-forward-on-expand          nil
            treemacs-no-png-images                   nil
            treemacs-no-delete-other-windows         t
            treemacs-project-follow-cleanup          nil
            treemacs-persist-file                    (expand-file-name ".cache/treemacs-persist" user-emacs-directory)
            treemacs-position                        'left
            treemacs-read-string-input               'from-child-frame
            treemacs-recenter-distance               0.1
            treemacs-recenter-after-file-follow      nil
            treemacs-recenter-after-tag-follow       nil
            treemacs-recenter-after-project-jump     'always
            treemacs-recenter-after-project-expand   'on-distance
            treemacs-litter-directories              '("/node_modules" "/.venv" "/.cask")
            treemacs-project-follow-into-home        nil
            treemacs-show-cursor                     nil
            treemacs-show-hidden-files               t
            treemacs-silent-filewatch                nil
            treemacs-silent-refresh                  nil
            treemacs-sorting                         'alphabetic-asc
            treemacs-select-when-already-in-treemacs 'move-back
            treemacs-space-between-root-nodes        t
            treemacs-tag-follow-cleanup              t
            treemacs-tag-follow-delay                1.5
            treemacs-text-scale                      nil
            treemacs-user-mode-line-format           nil
            treemacs-user-header-line-format         nil
            treemacs-wide-toggle-width               70
            treemacs-width                           35
            treemacs-width-increment                 1
            treemacs-width-is-initially-locked       t
            treemacs-workspace-switch-cleanup        nil)

      ;; The default width and height of the icons is 22 pixels. If you are
      ;; using a Hi-DPI display, uncomment this to double the icon size.
      ;;(treemacs-resize-icons 44)

      (treemacs-follow-mode t)
      (treemacs-filewatch-mode t)
      (treemacs-fringe-indicator-mode 'always)
      (when treemacs-python-executable
        (treemacs-git-commit-diff-mode t))

      (pcase (cons (not (null (executable-find "git")))
                   (not (null treemacs-python-executable)))
        (`(t . t)
         (treemacs-git-mode 'deferred))
        (`(t . _)
         (treemacs-git-mode 'simple)))

      (treemacs-hide-gitignored-files-mode nil))
    :bind
    (:map global-map
          ("M-0"       . treemacs-select-window)
          ("C-x t 1"   . treemacs-delete-other-windows)
          ("C-x t t"   . treemacs)
          ("C-x t d"   . treemacs-select-directory)
          ("C-x t B"   . treemacs-bookmark)
          ("C-x t C-t" . treemacs-find-file)
          ("C-x t M-t" . treemacs-find-tag)))

  (use-package treemacs-evil
    :after (treemacs evil)
    :ensure t)

  (use-package treemacs-projectile
    :after (treemacs projectile)
    :ensure t)

  (use-package treemacs-icons-dired
    :hook (dired-mode . treemacs-icons-dired-enable-once)
    :ensure t)

  (use-package treemacs-magit
    :after (treemacs magit)
    :ensure t)

  ;;(treemacs-start-on-boot)
#+end_src
* Performance
** lsp-mode 
lsp-mode creates a lot of garbage
#+begin_src emacs-lisp
  (setq gc-cons-threshold 100000000)
#+end_src

Increase the amount of data Emacs reads from a processes
#+begin_src emacs-lisp
  (setq read-process-output-max (* 1024 1024)) ;; 1mb
#+end_src

Emacs LSP performance booster: https://github.com/blahgeek/emacs-lsp-booster
#+begin_src sh
  cargo install emacs-lsp-booster
#+end_src

#+begin_src emacs-lisp
  (defun lsp-booster--advice-json-parse (old-fn &rest args)
    "Try to parse bytecode instead of json."
    (or
     (when (equal (following-char) ?#)
       (let ((bytecode (read (current-buffer))))
         (when (byte-code-function-p bytecode)
           (funcall bytecode))))
     (apply old-fn args)))
  (advice-add (if (progn (require 'json)
                         (fboundp 'json-parse-buffer))
                  'json-parse-buffer
                'json-read)
              :around
              #'lsp-booster--advice-json-parse)

  (defun lsp-booster--advice-final-command (old-fn cmd &optional test?)
    "Prepend emacs-lsp-booster command to lsp CMD."
    (let ((orig-result (funcall old-fn cmd test?)))
      (if (and (not test?)                             ;; for check lsp-server-present?
               (not (file-remote-p default-directory)) ;; see lsp-resolve-final-command, it would add extra shell wrapper
               lsp-use-plists
               (not (functionp 'json-rpc-connection))  ;; native json-rpc
               (executable-find "emacs-lsp-booster"))
          (progn
            (when-let ((command-from-exec-path (executable-find (car orig-result))))  ;; resolve command from exec-path (in case not found in $PATH)
              (setcar orig-result command-from-exec-path))
            (message "Using emacs-lsp-booster for %s!" orig-result)
            (cons "emacs-lsp-booster" orig-result))
        orig-result)))
  (advice-add 'lsp-resolve-final-command :around #'lsp-booster--advice-final-command)
#+end_src

* TODO 
** TODO Set up lsp-mode
*** Add bindings for lsp-mode
*** check out dap-mode debugger
** TODO Profile helpful, it's very slow on initial run
** TODO Investigate switching to elpaca
** TODO Checkout ebook packages
- https://github.com/bddean/emacs-ereader
  or
- https://github.com/chenyanming/calibredb.el
- https://depp.brause.cc/nov.el/
- https://github.com/chenyanming/anki.el
 
